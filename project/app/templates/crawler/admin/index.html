<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据采集管理 - 舆情分析系统</title>
    <!-- 引入layui样式 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='layui/css/layui.css') }}">
    <!-- 引入自定义样式 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .crawl-card {
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fff;
            transition: all 0.3s;
        }
        
        .crawl-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #1E9FFF;
        }
        
        .crawl-card .cover {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
            float: left;
        }
        
        .crawl-card .content {
            margin-left: 115px;
        }
        
        .crawl-card .title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .crawl-card .summary {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .crawl-card .meta {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }
        
        .crawl-card .actions {
            margin-top: 10px;
        }
        
        .progress-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            display: none;
        }
        
        .layui-upload-list img {
            width: 92px;
            height: 92px;
            margin: 0 10px 10px 0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .status-badge.depth-crawled {
            background-color: #5FB878;
            color: #fff;
        }
        
        .status-badge.not-depth-crawled {
            background-color: #FFB800;
            color: #fff;
        }
        
        .status-badge.stored {
            background-color: #1E9FFF;
            color: #fff;
        }
        
        .status-badge.not-stored {
            background-color: #FF5722;
            color: #fff;
        }
        
        .select-all-container {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
        }
        
        .result-list {
            margin-top: 20px;
        }
        
        /* 响应式布局 */
        @media (max-width: 768px) {
            .crawl-card .cover {
                width: 80px;
                height: 80px;
            }
            
            .crawl-card .content {
                margin-left: 95px;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="layui-header">
        <div class="layui-container">
            <a href="{{ url_for('main.index') }}" class="layui-logo">舆情分析系统</a>
            <!-- 导航菜单 -->
            <ul class="layui-nav layui-layout-right">
                <li class="layui-nav-item"><a href="{{ url_for('main.index') }}">首页</a></li>
                <li class="layui-nav-item"><a href="{{ url_for('main.dashboard') }}">数据采集</a></li>
                <li class="layui-nav-item layui-this"><a href="{{ url_for('admin_crawler.data_collection_page') }}">数据采集</a></li>
                <li class="layui-nav-item"><a href="{{ url_for('admin_crawler.rules_page') }}">采集规则库</a></li>
                <li class="layui-nav-item layui-nav-itemed">
                    <a href="javascript:;">{{ current_user.username }}</a>
                    <dl class="layui-nav-child">
                        <dd><a href="{{ url_for('auth.logout') }}">退出登录</a></dd>
                    </dl>
                </li>
            </ul>
        </div>
    </div>

    <!-- 页面内容 -->
    <div class="layui-container">
        <div class="layui-row">
            <div class="layui-col-md12">
                <div class="page-header">
                    <h2>数据采集管理</h2>
                    <p>通过关键词采集网络数据</p>
                </div>
                
                <!-- 数据采集表单 -->
                <div class="layui-card">
                    <div class="layui-card-header">
                        <h3 class="layui-card-title">数据采集</h3>
                    </div>
                    <div class="layui-card-body">
                        <form class="layui-form" id="crawl-form">
                            <div class="layui-form-item">
                                <label class="layui-form-label">采集关键词</label>
                                <div class="layui-input-block">
                                    <input type="text" name="keyword" id="keyword" required  lay-verify="required" placeholder="请输入要采集的关键词" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">数据源</label>
                                <div class="layui-input-block">
                                    <select name="source" lay-verify="required">
                                        <option value="baidu">百度搜索</option>
                                        <option value="bing">Bing搜索</option>
                                        <option value="xinhua">新华新闻</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button class="layui-btn" id="crawl-btn" lay-submit lay-filter="crawl">开始采集</button>
                                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                                    <button type="button" class="layui-btn layui-btn-normal" id="form-store-btn">存储</button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- 采集进度 -->
                        <div class="progress-container" id="progress-container">
                            <div class="layui-progress" lay-showpercent="true">
                                <div class="layui-progress-bar" lay-percent="0%"></div>
                            </div>
                            <div class="progress-message" style="margin-top: 10px; color: #666; font-size: 14px;">
                                准备开始采集...
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 批量操作 -->
                <div class="select-all-container">
                    <div class="layui-form">
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <input type="checkbox" name="select_all" id="select_all" lay-skin="primary" title="全选">
                                <button class="layui-btn layui-btn-sm layui-btn-normal" id="batch-store-btn">批量存储</button>
                                <button class="layui-btn layui-btn-sm layui-btn-danger" id="batch-delete-btn">批量删除</button>
                                <span id="selected-count" style="margin-left: 10px; color: #666;">已选择 0 项</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 采集结果列表 -->
                <div class="result-list" id="result-list">
                    <!-- 结果将通过JavaScript动态生成 -->
                </div>
                
                <!-- 分页 -->
                <div id="pagination" class="layui-box layui-laypage layui-laypage-default"></div>
            </div>
        </div>
    </div>

    <!-- 引入layui脚本 -->
    <script src="{{ url_for('static', filename='layui/layui.js') }}"></script>
    <script>
        // 初始化layui组件
        layui.use(['form', 'layedit', 'laydate', 'element', 'layer', 'upload', 'laypage'], function() {
            var form = layui.form,
                layer = layui.layer,
                element = layui.element,
                upload = layui.upload,
                laypage = layui.laypage;
            
            // 监听采集表单提交
            form.on('submit(crawl)', function(data) {
                // 显示进度条
                $('#progress-container').show();
                element.progress('layui-progress-bar', '0%');
                $('.progress-message').text('正在采集数据...');
                
                // 禁用采集按钮
                $('#crawl-btn').attr('disabled', true).addClass('layui-btn-disabled');
                
                // 发送采集请求
                $.post("{{ url_for('admin_crawler.api_crawl_data') }}", data.field, function(res) {
                    if (res.success) {
                        // 更新进度为100%
                        element.progress('layui-progress-bar', '100%');
                        $('.progress-message').text('采集完成！');
                        
                        // 显示结果
                        renderResults(res.results);
                        
                        // 提示成功
                        layer.msg('采集完成，共采集到' + res.results.length + '条数据', {icon: 1});
                    } else {
                        // 提示失败
                        layer.msg(res.message, {icon: 2});
                        $('.progress-message').text('采集失败：' + res.message);
                    }
                    
                    // 启用采集按钮
                    $('#crawl-btn').removeAttr('disabled').removeClass('layui-btn-disabled');
                }, 'json').fail(function() {
                    layer.msg('采集请求失败，请重试', {icon: 2});
                    $('.progress-message').text('采集请求失败，请重试');
                    $('#crawl-btn').removeAttr('disabled').removeClass('layui-btn-disabled');
                });
                
                return false; // 阻止表单刷新
            });
            
            // 渲染采集结果
            function renderResults(results) {
                var html = '';
                
                if (results.length === 0) {
                    html = '<div class="layui-text-center" style="padding: 50px 0;"><p>暂无采集结果</p></div>';
                } else {
                    results.forEach(function(result) {
                        // 生成状态标签
                        var depthStatus = result.depth_crawled ? 
                            '<span class="status-badge depth-crawled">已深度采集</span>' : 
                            '<span class="status-badge not-depth-crawled">未深度采集</span>';
                            
                        var storeStatus = result.is_stored ? 
                            '<span class="status-badge stored">已存储</span>' : 
                            '<span class="status-badge not-stored">未存储</span>';
                        
                        html += `
                            <div class="crawl-card">
                                <div class="layui-form">
                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <input type="checkbox" name="result_ids" lay-skin="primary" title="" value="${result.id}">
                                        </div>
                                    </div>
                                </div>
                                <img src="${result.cover || '/static/images/default-cover.jpg'}" alt="封面" class="cover">
                                <div class="content">
                                    <h4 class="title"><a href="${result.original_url}" target="_blank">${result.title}</a></h4>
                                    <p class="summary">${result.summary}</p>
                                    <div class="meta">
                                        <span>来源：${result.source || '未知'}</span>
                                    </div>
                                    <div class="meta">
                                        ${depthStatus}
                                        ${storeStatus}
                                    </div>
                                    <div class="actions">
                                        <button class="layui-btn layui-btn-xs layui-btn-warm depth-crawl-btn" data-id="${result.id}">
                                            ${result.depth_crawled ? '重新深度采集' : '深度采集'}
                                        </button>
                                        <button class="layui-btn layui-btn-xs layui-btn-primary view-detail-btn" data-id="${result.id}">
                                            查看详情
                                        </button>
                                        <button class="layui-btn layui-btn-xs ${result.is_stored ? 'layui-btn-disabled' : 'layui-btn-normal'}" data-id="${result.id}">
                                            ${result.is_stored ? '已存储' : '存储到数据库'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                $('#result-list').html(html);
                form.render(); // 重新渲染表单
            }
            
            // 深度采集按钮点击事件
            $(document).on('click', '.depth-crawl-btn', function() {
                var id = $(this).data('id');
                var btn = $(this);
                var originalText = btn.text();
                
                // 禁用按钮
                btn.attr('disabled', true).text('正在深度采集...');
                
                // 发送深度采集请求
                $.post("{{ url_for('admin_crawler.api_depth_crawl') }}", {result_id: id}, function(res) {
                    if (res.success) {
                        layer.msg('深度采集完成', {icon: 1});
                        // 更新按钮文本
                        btn.text('重新深度采集').removeClass('layui-btn-warm').addClass('layui-btn-success');
                        // 更新状态
                        var card = btn.closest('.crawl-card');
                        card.find('.status-badge.not-depth-crawled').removeClass('not-depth-crawled').addClass('depth-crawled').text('已深度采集');
                    } else {
                        layer.msg(res.message, {icon: 2});
                        btn.text(originalText);
                    }
                    
                    // 启用按钮
                    btn.removeAttr('disabled');
                }, 'json').fail(function() {
                    layer.msg('深度采集请求失败，请重试', {icon: 2});
                    btn.text(originalText).removeAttr('disabled');
                });
            });
            
            // 全选功能
            form.on('checkbox(select_all)', function(data) {
                var checkboxes = $('input[name="result_ids"]');
                checkboxes.each(function() {
                    this.checked = data.elem.checked;
                });
                form.render('checkbox');
                updateSelectedCount();
            });
            
            // 单个选择功能
            form.on('checkbox(result_ids)', function() {
                updateSelectedCount();
            });
            
            // 更新已选择数量
            function updateSelectedCount() {
                var checkedCount = $('input[name="result_ids"]:checked').length;
                $('#selected-count').text('已选择 ' + checkedCount + ' 项');
                
                // 更新全选状态
                var totalCount = $('input[name="result_ids"]').length;
                $('#select_all')[0].checked = checkedCount === totalCount;
                form.render('checkbox');
            }
            
            // 批量存储按钮点击事件
            function handleStoreData() {
                var checkedIds = $('input[name="result_ids"]:checked').map(function() {
                    return $(this).val();
                }).get();
                
                if (checkedIds.length === 0) {
                    layer.msg('请先选择要存储的数据', {icon: 2});
                    return;
                }
                
                layer.confirm('确定要将选中的' + checkedIds.length + '条数据存储到数据库吗？', {
                    btn: ['确定', '取消']
                }, function(index) {
                    // 发送批量存储请求
                    $.post("{{ url_for('admin_crawler.api_store_data') }}", {result_ids: checkedIds.join(',')}, function(res) {
                        if (res.success) {
                            layer.msg('存储成功，共存储' + res.updated_count + '条数据', {icon: 1});
                            // 更新状态
                            checkedIds.forEach(function(id) {
                                var card = $(`input[name="result_ids"][value="${id}"]`).closest('.crawl-card');
                                card.find('.status-badge.not-stored').removeClass('not-stored').addClass('stored').text('已存储');
                                card.find('.layui-btn-normal').addClass('layui-btn-disabled').text('已存储');
                            });
                        } else {
                            layer.msg(res.message, {icon: 2});
                        }
                    }, 'json').fail(function() {
                        layer.msg('存储请求失败，请重试', {icon: 2});
                    });
                    
                    layer.close(index);
                });
            }
            
            // 批量存储按钮点击事件
            $('#batch-store-btn').click(handleStoreData);
            
            // 表单存储按钮点击事件
            $('#form-store-btn').click(handleStoreData);
            
            // 批量删除按钮点击事件
            $('#batch-delete-btn').click(function() {
                var checkedIds = $('input[name="result_ids"]:checked').map(function() {
                    return $(this).val();
                }).get();
                
                if (checkedIds.length === 0) {
                    layer.msg('请先选择要删除的数据', {icon: 2});
                    return;
                }
                
                layer.confirm('确定要删除选中的' + checkedIds.length + '条数据吗？', {
                    btn: ['确定', '取消']
                }, function(index) {
                    // 发送批量删除请求
                    $.post("{{ url_for('admin_crawler.api_delete_selected') }}", {result_ids: checkedIds.join(',')}, function(res) {
                        if (res.success) {
                            layer.msg('删除成功', {icon: 1});
                            // 移除已删除的卡片
                            checkedIds.forEach(function(id) {
                                $(`input[name="result_ids"][value="${id}"]`).closest('.crawl-card').remove();
                            });
                            updateSelectedCount();
                        } else {
                            layer.msg(res.message, {icon: 2});
                        }
                    }, 'json').fail(function() {
                        layer.msg('删除请求失败，请重试', {icon: 2});
                    });
                    
                    layer.close(index);
                });
            });
            
            // 查看详情按钮点击事件
            $(document).on('click', '.view-detail-btn', function() {
                var id = $(this).data('id');
                // 这里可以实现查看详情的功能
                layer.msg('查看详情功能开发中...', {icon: 0});
            });
            
            // 单个存储按钮点击事件
            $(document).on('click', '.layui-btn-normal', function() {
                var id = $(this).data('id');
                var btn = $(this);
                var originalText = btn.text();
                
                if (btn.hasClass('layui-btn-disabled')) {
                    return; // 已存储的按钮不可点击
                }
                
                // 禁用按钮
                btn.attr('disabled', true).text('正在存储...');
                
                // 发送单个存储请求
                $.post("{{ url_for('admin_crawler.api_store_data') }}", {result_ids: id}, function(res) {
                    if (res.success) {
                        layer.msg('存储成功', {icon: 1});
                        // 更新按钮状态
                        btn.addClass('layui-btn-disabled').text('已存储');
                        // 更新状态徽章
                        var card = btn.closest('.crawl-card');
                        card.find('.status-badge.not-stored').removeClass('not-stored').addClass('stored').text('已存储');
                    } else {
                        layer.msg(res.message, {icon: 2});
                        btn.text(originalText);
                    }
                    
                    // 启用按钮
                    btn.removeAttr('disabled');
                }, 'json').fail(function() {
                    layer.msg('存储请求失败，请重试', {icon: 2});
                    btn.text(originalText).removeAttr('disabled');
                });
            });
            
            // 页面加载时获取历史采集结果
            function loadHistoryResults() {
                $.get("{{ url_for('admin_crawler.api_crawl_results') }}", {page: 1, limit: 10}, function(res) {
                    if (res.success) {
                        renderResults(res.data);
                        // 渲染分页
                        renderPagination(res.total, res.page, res.limit);
                    }
                }, 'json');
            }
            
            // 渲染分页
            function renderPagination(total, currentPage, limit) {
                laypage.render({
                    elem: 'pagination',
                    count: total,
                    limit: limit,
                    curr: currentPage,
                    layout: ['prev', 'page', 'next', 'skip', 'count'],
                    jump: function(obj, first) {
                        if (!first) {
                            $.get("{{ url_for('admin_crawler.api_crawl_results') }}", {page: obj.curr, limit: obj.limit}, function(res) {
                                if (res.success) {
                                    renderResults(res.data);
                                }
                            }, 'json');
                        }
                    }
                });
            }
            
            // 页面加载完成后加载历史结果
            $(document).ready(function() {
                loadHistoryResults();
            });
        });
    </script>
</body>
</html>