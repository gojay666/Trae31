{% extends "base.html" %}

{% block title %}采集规则库{% endblock %}

{% block css %}
    <style>
        /* 自定义样式 */
        .main-content {
            padding: 20px;
        }
        .header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e6e6e6;
        }
        .header h2 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        .search-box {
            margin-bottom: 15px;
        }
        .btn-add {
            margin-bottom: 15px;
        }
        .form-container {
            padding: 20px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header">
            <h2>采集规则库</h2>
            <p>管理不同站点的采集规则</p>
        </div>
        <div class="layui-card-body">
            <div class="main-content">
        <div class="header">
            <h2>采集规则库</h2>
        </div>

        <!-- 搜索框 -->
        <div class="search-box">
            <div class="layui-input-group">
                <input type="text" class="layui-input" id="keyword" placeholder="搜索站点名称或URL">
                <div class="layui-input-group-addon">
                    <button class="layui-btn layui-btn-primary" id="search-btn">搜索</button>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="btn-add">
            <button class="layui-btn layui-btn-normal" id="add-rule-btn">
                <i class="layui-icon layui-icon-add-1"></i> 新增规则
            </button>
        </div>

        <!-- 规则列表表格，添加水平滚动容器 -->
        <div style="overflow-x: auto;">
            <table class="layui-hide" id="rules-table" lay-filter="rules-table"></table>
        </div>

        <!-- 工具栏模板 -->
        <script type="text/html" id="rules-toolbar">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="batchDelete">
                    <i class="layui-icon layui-icon-delete"></i> 批量删除
                </button>
            </div>
        </script>

        <!-- 操作列模板 -->
        <script type="text/html" id="rules-bar">
            <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>
        </script>

        <!-- 状态列模板 -->
        <script type="text/html" id="is-active-tpl">
            {% raw %}
            <span class="layui-badge {{ 'layui-bg-green' if d.is_active else 'layui-bg-gray' }}">{{ '启用' if d.is_active else '禁用' }}</span>
            {% endraw %}
        </script>
    </div>

    <!-- 规则表单弹出层 -->
    <div id="rule-form" style="display: none;">
        <form class="layui-form form-container" lay-filter="rule-form">
            <input type="hidden" name="id">
            <div class="layui-form-item">
                <label class="layui-form-label">站点名称</label>
                <div class="layui-input-block">
                    <input type="text" name="site_name" required lay-verify="required" placeholder="请输入站点名称" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">站点URL</label>
                <div class="layui-input-block">
                    <input type="text" name="site_url" required lay-verify="required" placeholder="请输入站点URL" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">标题XPATH</label>
                <div class="layui-input-block">
                    <input type="text" name="title_xpath" required lay-verify="required" placeholder="请输入标题XPATH" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">详细内容XPATH</label>
                <div class="layui-input-block">
                    <input type="text" name="content_xpath" required lay-verify="required" placeholder="请输入详细内容XPATH" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">请求头</label>
                <div class="layui-input-block">
                    <textarea name="request_headers" placeholder="请输入请求头(JSON格式)" autocomplete="off" class="layui-textarea" style="min-height: 150px;"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="is_active" lay-skin="switch" lay-text="启用|禁用" checked>
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="submit-rule">提交</button>
                    <button type="button" class="layui-btn layui-btn-primary" id="cancel-btn">取消</button>
                </div>
            </div>
        </form>
    </div>

    <!-- 引入layui脚本 -->
    <script src="/static/layui/layui.js"></script>
    <script>
        // 初始化layui组件
        layui.use(['table', 'form', 'layer', 'jquery'], function() {
            var table = layui.table;
            var form = layui.form;
            var layer = layui.layer;
            var $ = layui.jquery;

            // 表单弹出层索引
            var formIndex = null;

            // 渲染表格
            var tableIns = table.render({
                elem: '#rules-table',
                url: '/admin/api/rules',
                toolbar: '#rules-toolbar',
                title: '站点采集规则',
                cols: [[
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'id', title: 'ID', width: 80, fixed: 'left', sort: true},
                    {field: 'site_name', title: '站点名称', width: 200, sort: true},
                    {field: 'site_url', title: '站点URL', width: 300},
                    {field: 'title_xpath', title: '标题XPATH', width: 200},
                    {field: 'content_xpath', title: '内容XPATH', width: 200},
                    {field: 'is_active', title: '状态', width: 100, templet: '#is-active-tpl'},
                    {field: 'created_at', title: '创建时间', width: 180, sort: true},
                    {fixed: 'right', title: '操作', toolbar: '#rules-bar', width: 150}
                ]],
                page: true,
                height: 'full-150',
                cellMinWidth: 80,
                even: true
            });

            // 搜索功能
            $('#search-btn').on('click', function() {
                var keyword = $('#keyword').val();
                tableIns.reload({
                    where: {
                        keyword: keyword
                    },
                    page: {
                        curr: 1
                    }
                });
            });

            // 新增规则按钮点击事件
            $('#add-rule-btn').on('click', function() {
                // 重置表单
                form.val('rule-form', {});
                // 打开弹出层
                formIndex = layer.open({
                    type: 1,
                    title: '新增采集规则',
                    area: ['800px', '600px'],
                    content: $('#rule-form'),
                    success: function() {
                        // 表单验证
                        form.validate();
                    }
                });
            });

            // 取消按钮点击事件
            $('#cancel-btn').on('click', function() {
                layer.close(formIndex);
            });

            // 表单提交事件
            form.on('submit(submit-rule)', function(data) {
                var ruleData = data.field;
                var url = '/admin/api/rules';
                var method = 'POST';

                // 如果有ID则是更新操作
                if (ruleData.id) {
                    url = '/admin/api/rules/' + ruleData.id;
                    method = 'PUT';
                }

                // 处理请求头
                var headers = ruleData.request_headers;
                if (headers) {
                    try {
                        JSON.parse(headers);
                    } catch (e) {
                        layer.msg('请求头格式错误，请输入有效的JSON格式', {icon: 2});
                        return false;
                    }
                }

                // 发送AJAX请求
                $.ajax({
                    url: url,
                    type: method,
                    data: ruleData,
                    success: function(res) {
                        if (res.success) {
                            layer.msg(res.message, {icon: 1});
                            layer.close(formIndex);
                            // 重新渲染表格
                            tableIns.reload();
                        } else {
                            layer.msg(res.message, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.msg('操作失败，请稍后重试', {icon: 2});
                    }
                });

                return false;
            });

            // 监听表格工具条事件
            table.on('tool(rules-table)', function(obj) {
                var data = obj.data;
                var layEvent = obj.event;

                // 编辑规则
                if (layEvent === 'edit') {
                    // 填充表单数据
                    form.val('rule-form', {
                        id: data.id,
                        site_name: data.site_name,
                        site_url: data.site_url,
                        title_xpath: data.title_xpath,
                        content_xpath: data.content_xpath,
                        request_headers: JSON.stringify(data.request_headers, null, 2),
                        is_active: data.is_active
                    });

                    // 打开弹出层
                    formIndex = layer.open({
                        type: 1,
                        title: '编辑采集规则',
                        area: ['800px', '600px'],
                        content: $('#rule-form'),
                        success: function() {
                            // 表单验证
                            form.validate();
                            // 渲染开关状态
                            form.render('checkbox');
                        }
                    });
                }

                // 删除规则
                else if (layEvent === 'delete') {
                    layer.confirm('确定要删除该采集规则吗？', function(index) {
                        // 发送删除请求
                        $.ajax({
                            url: '/admin/api/rules/' + data.id,
                            type: 'DELETE',
                            success: function(res) {
                                if (res.success) {
                                    layer.msg(res.message, {icon: 1});
                                    obj.del();
                                } else {
                                    layer.msg(res.message, {icon: 2});
                                }
                            },
                            error: function() {
                                layer.msg('删除失败，请稍后重试', {icon: 2});
                            }
                        });
                        layer.close(index);
                    });
                }
            });

            // 监听表格头部工具栏事件
            table.on('toolbar(rules-table)', function(obj) {
                var checkStatus = table.checkStatus(obj.config.id);
                var data = checkStatus.data;

                // 批量删除
                if (obj.event === 'batchDelete') {
                    if (data.length === 0) {
                        layer.msg('请选择要删除的规则', {icon: 2});
                        return;
                    }

                    layer.confirm('确定要批量删除选中的规则吗？', function(index) {
                        var ids = data.map(function(item) {
                            return item.id;
                        });

                        // 发送批量删除请求
                        var deleteCount = 0;
                        var total = ids.length;

                        // 逐个删除
                        ids.forEach(function(id, i) {
                            $.ajax({
                                url: '/admin/api/rules/' + id,
                                type: 'DELETE',
                                success: function(res) {
                                    if (res.success) {
                                        deleteCount++;
                                    }
                                    // 如果是最后一个请求，显示结果
                                    if (i === total - 1) {
                                        layer.msg('成功删除' + deleteCount + '条规则', {icon: 1});
                                        // 重新渲染表格
                                        tableIns.reload();
                                    }
                                },
                                error: function() {
                                    // 如果是最后一个请求，显示结果
                                    if (i === total - 1) {
                                        layer.msg('成功删除' + deleteCount + '条规则，部分删除失败', {icon: 1});
                                        // 重新渲染表格
                                        tableIns.reload();
                                    }
                                }
                            });
                        });

                        layer.close(index);
                    });
                }
            });
        });
    </script>
{% endblock %}