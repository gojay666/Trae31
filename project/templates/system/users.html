{% extends "base.html" %}

{% block title %}用户管理{% endblock %}

{% block header %}用户管理{% endblock %}

{% block content %}
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <span class="layui-breadcrumb">
                        <a href="{{ url_for('main.index') }}"><i class="layui-icon layui-icon-home"></i> 首页</a>
                        <a href="{{ url_for('system.index') }}"><i class="layui-icon layui-icon-set"></i> 系统设置</a>
                        <a><cite>用户管理</cite></a>
                    </span>
                    <div class="layui-card-header-tool">
                        <button class="layui-btn layui-btn-normal layui-btn-sm" id="addUserBtn">
                            <i class="layui-icon layui-icon-plus"></i> 添加用户
                        </button>
                    </div>
                </div>
                <div class="layui-card-body">
                    <!-- 搜索条件 -->
                    <div class="layui-form layui-card-header layuiadmin-card-header-auto" style="margin: -15px -15px 15px;">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">用户名</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="username" placeholder="请输入用户名" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">邮箱</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="email" placeholder="请输入邮箱" autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">状态</label>
                                <div class="layui-input-inline">
                                    <select name="status">
                                        <option value="">全部</option>
                                        <option value="1">启用</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button class="layui-btn layui-btn-primary" lay-submit lay-filter="search">
                                    <i class="layui-icon layui-icon-search"></i> 搜索
                                </button>
                                <button class="layui-btn layui-btn-primary" lay-submit lay-filter="reset">
                                    <i class="layui-icon layui-icon-refresh"></i> 重置
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 用户列表 -->
                    <table class="layui-hide" id="userTable" lay-filter="userTable"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- 工具栏 -->
    <script type="text/html" id="userToolBar">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-normal layui-btn-sm" lay-event="edit">
                <i class="layui-icon layui-icon-edit"></i> 编辑
            </button>
            <button class="layui-btn layui-btn-danger layui-btn-sm" lay-event="delete">
                <i class="layui-icon layui-icon-delete"></i> 删除
            </button>
            <button class="layui-btn layui-btn-warm layui-btn-sm" lay-event="toggle">
                <i class="layui-icon layui-icon-switch"></i> {{ d.is_active ? '禁用' : '启用' }}
            </button>
        </div>
    </script>

    <!-- 状态列 -->
    <script type="text/html" id="statusTpl">
        <input type="checkbox" name="status" value="{{ d.id }}" lay-skin="switch" lay-text="启用|禁用" {{ d.is_active ? 'checked' : '' }} lay-filter="statusSwitch">
    </script>

    <!-- 角色列 -->
    <script type="text/html" id="roleTpl">
        <span class="layui-badge {{ d.is_admin ? 'layui-bg-blue' : 'layui-bg-green' }}">{{ d.is_admin ? '管理员' : '普通用户' }}</span>
    </script>

    <!-- 添加/编辑用户弹窗 -->
    <div id="userModal" style="display: none;">
        <form class="layui-form" lay-filter="userForm">
            <input type="hidden" name="id" id="userId">
            <div class="layui-form-item">
                <label class="layui-form-label">用户名</label>
                <div class="layui-input-block">
                    <input type="text" name="username" placeholder="请输入2-20个字符的用户名" autocomplete="off" class="layui-input" lay-verify="required|username">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">邮箱</label>
                <div class="layui-input-block">
                    <input type="text" name="email" placeholder="请输入有效的邮箱地址" autocomplete="off" class="layui-input" lay-verify="required|email">
                </div>
            </div>
            <div class="layui-form-item" id="passwordField">
                <label class="layui-form-label">密码</label>
                <div class="layui-input-block">
                    <input type="password" name="password" placeholder="请输入至少6位密码" autocomplete="off" class="layui-input" lay-verify="required|password">
                </div>
            </div>
            <div class="layui-form-item" id="confirmPasswordField">
                <label class="layui-form-label">确认密码</label>
                <div class="layui-input-block">
                    <input type="password" name="confirm_password" placeholder="请再次输入密码" autocomplete="off" class="layui-input" lay-verify="required|confirmPassword">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">角色</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="is_admin" lay-skin="primary" title="管理员">
                    <div class="layui-form-mid layui-word-aux">勾选后该用户将拥有管理员权限</div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="is_active" lay-skin="primary" title="启用" checked>
                    <div class="layui-form-mid layui-word-aux">禁用后用户将无法登录系统</div>
                </div>
            </div>
        </form>
    </div>

    <script>
        layui.use(['table', 'form', 'layer'], function() {
            var table = layui.table;
            var form = layui.form;
            var layer = layui.layer;

            // 初始化表格
            var userTable = table.render({
                elem: '#userTable',
                url: '{{ url_for("system.get_users") }}',
                method: 'POST',
                toolbar: '#userToolBar',
                title: '用户列表',
                cols: [[
                    {field: 'id', title: 'ID', width: 80, align: 'center'},
                    {field: 'username', title: '用户名', width: 150, align: 'center'},
                    {field: 'email', title: '邮箱', width: 200, align: 'center'},
                    {field: 'is_admin', title: '角色', width: 100, align: 'center', templet: '#roleTpl'},
                    {field: 'is_active', title: '状态', width: 100, align: 'center', templet: '#statusTpl'},
                    {field: 'created_at', title: '创建时间', width: 180, align: 'center'},
                    {field: 'updated_at', title: '更新时间', width: 180, align: 'center'},
                    {title: '操作', width: 200, align: 'center', toolbar: '#userToolBar'}
                ]],
                page: true,
                limit: 10,
                limits: [10, 20, 30, 50],
                cellMinWidth: 80,
                text: {
                    none: '暂无相关数据'
                }
            });

            // 搜索
            form.on('submit(search)', function(data) {
                userTable.reload({
                    where: data.field,
                    page: {
                        curr: 1
                    }
                });
                return false;
            });

            // 重置
            form.on('submit(reset)', function() {
                form.val('searchForm', {
                    username: '',
                    email: '',
                    status: ''
                });
                userTable.reload({
                    where: {},
                    page: {
                        curr: 1
                    }
                });
                return false;
            });

            // 状态开关
            form.on('switch(statusSwitch)', function(obj) {
                var id = this.value;
                var status = obj.elem.checked ? 1 : 0;
                
                $.ajax({
                    url: '{{ url_for("system.toggle_user_status") }}',
                    type: 'POST',
                    data: {id: id, status: status},
                    dataType: 'json',
                    success: function(res) {
                        if (res.code === 0) {
                            layer.msg(res.msg, {icon: 1});
                        } else {
                            layer.msg(res.msg, {icon: 2});
                            obj.elem.checked = !obj.elem.checked;
                            form.render('checkbox');
                        }
                    },
                    error: function() {
                        layer.msg('操作失败，请重试', {icon: 2});
                        obj.elem.checked = !obj.elem.checked;
                        form.render('checkbox');
                    }
                });
            });

            // 添加用户按钮
            $('#addUserBtn').click(function() {
                showUserModal();
            });

            // 行工具事件
            table.on('tool(userTable)', function(obj) {
                var data = obj.data;
                var layEvent = obj.event;
                
                if (layEvent === 'edit') {
                    showUserModal(data);
                } else if (layEvent === 'delete') {
                    deleteUser(data.id, data.username);
                } else if (layEvent === 'toggle') {
                    toggleUserStatus(data.id, !data.is_active);
                }
            });

            // 显示用户弹窗
            function showUserModal(userData) {
                // 重置表单
                form.val('userForm', {
                    id: '',
                    username: '',
                    email: '',
                    password: '',
                    confirm_password: '',
                    is_admin: '',
                    is_active: true
                });
                
                // 显示密码字段
                $('#passwordField').show();
                $('#confirmPasswordField').show();
                
                // 如果是编辑模式
                if (userData) {
                    form.val('userForm', {
                        id: userData.id,
                        username: userData.username,
                        email: userData.email,
                        is_admin: userData.is_admin,
                        is_active: userData.is_active
                    });
                    
                    // 隐藏密码字段
                    $('#passwordField').hide();
                    $('#confirmPasswordField').hide();
                }
                
                // 打开弹窗
                layer.open({
                    type: 1,
                    title: userData ? '编辑用户' : '添加用户',
                    content: $('#userModal'),
                    area: ['500px', 'auto'],
                    btn: ['保存', '取消'],
                    success: function() {
                        form.render();
                    },
                    yes: function(index) {
                        form.on('submit(userSubmit)', function(data) {
                            saveUser(data.field, index);
                            return false;
                        });
                        
                        $('#userForm').find('button[type="submit"]').trigger('click');
                    }
                });
            }

            // 保存用户
            function saveUser(userData, index) {
                $.ajax({
                    url: userData.id ? '{{ url_for("system.update_user") }}' : '{{ url_for("system.add_user") }}',
                    type: 'POST',
                    data: userData,
                    dataType: 'json',
                    success: function(res) {
                        if (res.code === 0) {
                            layer.msg(res.msg, {icon: 1});
                            layer.close(index);
                            userTable.reload();
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.msg('保存失败，请重试', {icon: 2});
                    }
                });
            }

            // 删除用户
            function deleteUser(id, username) {
                layer.confirm('确定要删除用户 "' + username + '" 吗？', {
                    icon: 3,
                    title: '删除用户'
                }, function(index) {
                    $.ajax({
                        url: '{{ url_for("system.delete_user") }}',
                        type: 'POST',
                        data: {id: id},
                        dataType: 'json',
                        success: function(res) {
                            if (res.code === 0) {
                                layer.msg(res.msg, {icon: 1});
                                userTable.reload();
                            } else {
                                layer.msg(res.msg, {icon: 2});
                            }
                        },
                        error: function() {
                            layer.msg('删除失败，请重试', {icon: 2});
                        }
                    });
                    
                    layer.close(index);
                });
            }

            // 切换用户状态
            function toggleUserStatus(id, status) {
                $.ajax({
                    url: '{{ url_for("system.toggle_user_status") }}',
                    type: 'POST',
                    data: {id: id, status: status},
                    dataType: 'json',
                    success: function(res) {
                        if (res.code === 0) {
                            layer.msg(res.msg, {icon: 1});
                            userTable.reload();
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.msg('操作失败，请重试', {icon: 2});
                    }
                });
            }

            // 表单验证
            form.verify({
                username: function(value) {
                    if (value.length < 2 || value.length > 20) {
                        return '用户名长度必须在2到20个字符之间';
                    }
                },
                password: function(value) {
                    if (value.length < 6) {
                        return '密码长度不能少于6个字符';
                    }
                },
                confirmPassword: function(value) {
                    var password = $('input[name="password"]').val();
                    if (value !== password) {
                        return '两次输入的密码不一致';
                    }
                }
            });
        });
    </script>
{% endblock %}