{% extends "base.html" %}
{% block title %}AI引擎管理{% endblock %}

{% block content %}
<div class="layui-container-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <div class="layui-row">
                        <div class="layui-col-md6">
                            <h3>AI引擎管理</h3>
                        </div>
                        <div class="layui-col-md6 text-right">
                            <button class="layui-btn layui-btn-primary" onclick="window.refreshData()"><i class="layui-icon layui-icon-refresh"></i> 刷新</button>
                            <button class="layui-btn layui-btn-normal" onclick="window.addEngine()"><i class="layui-icon layui-icon-add-circle"></i> 添加引擎</button>
                        </div>
                    </div>
                </div>
                
                <div class="layui-card-body">
                    <!-- 搜索栏 -->
                    <div class="filter-container layui-form layui-form-pane">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">关键词</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="keyword" id="keyword" placeholder="服务商名称或模型名称" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button class="layui-btn layui-btn-primary" onclick="window.searchData()"><i class="layui-icon layui-icon-search"></i> 搜索</button>
                                <button class="layui-btn layui-btn-primary" onclick="window.clearSearch()">清空</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI引擎橱窗列表 -->
                    <div class="ai-engines-showcase" id="engines-container">
                        <!-- 橱窗列表将通过JavaScript动态生成 -->
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="layui-box layui-laypage layui-laypage-default" id="page-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑AI引擎模态框 -->
<div id="engine-modal" class="layui-modal" style="display: none; z-index: 1000;">
    <div class="layui-modal-content">
        <div class="layui-modal-header">
            <h3 id="modal-title">添加AI引擎</h3>
            <button type="button" class="layui-btn layui-btn-close layui-btn-sm" onclick="closeModal()">关闭</button>
        </div>
        <div class="layui-modal-body">
            <form class="layui-form" lay-filter="engine-form">
                <input type="hidden" name="id" id="engine-id">
                
                <div class="layui-form-item">
                    <label class="layui-form-label">服务商名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="provider_name" id="provider_name" required lay-verify="required" placeholder="请输入服务商名称" class="layui-input">
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">API地址</label>
                    <div class="layui-input-block">
                        <input type="text" name="api_url" id="api_url" required lay-verify="required|url" placeholder="请输入API地址" class="layui-input">
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">API密钥</label>
                    <div class="layui-input-block">
                        <input type="password" name="api_key" id="api_key" placeholder="请输入API密钥（编辑时可留空不修改）" class="layui-input">
                        <div class="layui-form-mid layui-word-aux">编辑时留空表示不修改现有密钥</div>
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">模型名称</label>
                    <div class="layui-input-block">
                        <input type="text" name="model_name" id="model_name" required lay-verify="required" placeholder="请输入模型名称" class="layui-input">
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">描述</label>
                    <div class="layui-input-block">
                        <textarea name="description" id="description" placeholder="请输入引擎描述" class="layui-textarea"></textarea>
                    </div>
                </div>
                
                <div class="layui-form-item">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-block">
                        <input type="checkbox" name="is_active" id="is_active" lay-skin="switch" lay-text="启用|禁用" checked>
                    </div>
                </div>
                
                <div class="layui-form-item layui-form-text text-center">
                    <button class="layui-btn layui-btn-primary" onclick="closeModal()">取消</button>
                    <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submit-engine">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 模态框遮罩层 -->
<div id="modal-mask" class="layui-mask" style="display: none; z-index: 999;"></div>
{% endblock %}

{% block js %}
<script src="{{ url_for('static', filename='layui/layui.js') }}"></script>
<script>
    // 页面加载完成后执行
    layui.use(['form', 'laypage', 'layer', 'jquery'], function() {
        var form = layui.form;
        var laypage = layui.laypage;
        var layer = layui.layer;
        var $ = layui.jquery;
        
        // 初始化数据
        loadData();
        
        // 表单提交事件
        form.on('submit(submit-engine)', function(data) {
            saveEngine(data.field);
            return false;
        });
        
        // 点击遮罩层关闭模态框
        $('#modal-mask').click(closeModal);
        
        // 加载AI引擎数据
        function loadData(page = 1, keyword = '') {
            $.ajax({
                url: '/api/warehouse/ai_engines',
                type: 'GET',
                data: {
                    page: page,
                    limit: 6, // 每页显示6个引擎卡片
                    keyword: keyword
                },
                success: function(res) {
                    if (res.code === 0) {
                        renderEngines(res.data);
                        renderPagination(page, res.count, keyword);
                    } else {
                        layer.msg(res.msg || '获取数据失败', {icon: 2});
                    }
                },
                error: function() {
                    layer.msg('网络错误，请稍后重试', {icon: 2});
                }
            });
        }
        
        // 渲染AI引擎橱窗列表
        function renderEngines(engines) {
            var container = $('#engines-container');
            container.empty();
            
            if (engines.length === 0) {
                container.html('<div class="empty-state">暂无AI引擎数据</div>');
                return;
            }
            
            engines.forEach(function(engine) {
                var engineCard = `
                    <div class="engine-card ${engine.is_active ? 'active' : 'inactive'}" data-id="${engine.id}">
                        <div class="engine-header">
                            <h4 class="engine-title">${engine.provider_name}</h4>
                            <div class="engine-status">
                                <span class="status-badge ${engine.is_active ? 'active' : 'inactive'}">
                                    ${engine.is_active ? '启用' : '禁用'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="engine-body">
                            <div class="engine-model">
                                <i class="layui-icon layui-icon-template-1"></i>
                                <span>${engine.model_name}</span>
                            </div>
                            
                            <div class="engine-url">
                                <i class="layui-icon layui-icon-link"></i>
                                <span>${engine.api_url}</span>
                            </div>
                            
                            ${engine.description ? `
                            <div class="engine-description">
                                <i class="layui-icon layui-icon-note"></i>
                                <p>${engine.description}</p>
                            </div>
                            ` : ''}
                            
                            <div class="engine-meta">
                                <span class="create-time">创建时间: ${engine.created_at}</span>
                                <span class="update-time">更新时间: ${engine.updated_at}</span>
                            </div>
                        </div>
                        
                        <div class="engine-footer">
                            <button class="layui-btn layui-btn-sm layui-btn-normal" onclick="window.editEngine(${engine.id})">
                                <i class="layui-icon layui-icon-edit"></i> 编辑
                            </button>
                            <button class="layui-btn layui-btn-sm ${engine.is_active ? 'layui-btn-warning' : 'layui-btn-normal'}" onclick="window.toggleEngineStatus(${engine.id}, ${!engine.is_active})">
                                <i class="layui-icon layui-icon-${engine.is_active ? 'close' : 'check'}"></i> ${engine.is_active ? '禁用' : '启用'}
                            </button>
                            <button class="layui-btn layui-btn-sm layui-btn-danger" onclick="window.deleteEngine(${engine.id})">
                                <i class="layui-icon layui-icon-delete"></i> 删除
                            </button>
                        </div>
                    </div>
                `;
                
                container.append(engineCard);
            });
        }
        
        // 渲染分页控件
        function renderPagination(currentPage, totalCount, keyword) {
            layui.laypage.render({
                elem: 'page-container',
                count: totalCount,
                curr: currentPage,
                limit: 6,
                layout: ['count', 'prev', 'page', 'next', 'skip'],
                jump: function(obj, first) {
                    if (!first) {
                        loadData(obj.curr, keyword);
                    }
                }
            });
        }
        
        // 刷新数据
        window.refreshData = function() {
            loadData();
        }
        
        // 搜索数据
        window.searchData = function() {
            var keyword = $('#keyword').val();
            loadData(1, keyword);
        }
        
        // 清空搜索
        window.clearSearch = function() {
            $('#keyword').val('');
            loadData();
        }
        
        // 添加引擎
        window.addEngine = function() {
            $('#engine-id').val('');
            $('#provider_name').val('');
            $('#api_url').val('');
            $('#api_key').val('');
            $('#model_name').val('');
            $('#description').val('');
            $('#is_active').prop('checked', true);
            $('#modal-title').text('添加AI引擎');
            
            form.render();
            showModal();
        }
        
        // 编辑引擎
        window.editEngine = function(id) {
            $.ajax({
                url: `/api/warehouse/ai_engines/${id}`,
                type: 'GET',
                success: function(res) {
                    if (res.code === 0) {
                        var engine = res.data;
                        $('#engine-id').val(engine.id);
                        $('#provider_name').val(engine.provider_name);
                        $('#api_url').val(engine.api_url);
                        $('#model_name').val(engine.model_name);
                        $('#description').val(engine.description);
                        $('#is_active').prop('checked', engine.is_active);
                        $('#modal-title').text('编辑AI引擎');
                        
                        form.render();
                        showModal();
                    } else {
                        layer.msg(res.msg || '获取引擎详情失败', {icon: 2});
                    }
                },
                error: function() {
                    layer.msg('网络错误，请稍后重试', {icon: 2});
                }
            });
        }
        
        // 保存引擎
        function saveEngine(engineData) {
            var url = engineData.id ? `/api/warehouse/ai_engines/${engineData.id}` : '/api/warehouse/ai_engines';
            var method = engineData.id ? 'PUT' : 'POST';
            
            $.ajax({
                url: url,
                type: method,
                data: engineData,
                success: function(res) {
                    if (res.code === 0) {
                        layer.msg(engineData.id ? '更新成功' : '添加成功', {icon: 1});
                        closeModal();
                        loadData();
                    } else {
                        layer.msg(res.msg || (engineData.id ? '更新失败' : '添加失败'), {icon: 2});
                    }
                },
                error: function() {
                    layer.msg('网络错误，请稍后重试', {icon: 2});
                }
            });
        }
        
        // 切换引擎状态
        window.toggleEngineStatus = function(id, isActive) {
            $.ajax({
                url: `/api/warehouse/ai_engines/${id}/status`,
                type: 'PUT',
                success: function(res) {
                    if (res.code === 0) {
                        layer.msg('状态更新成功', {icon: 1});
                        loadData();
                    } else {
                        layer.msg(res.msg || '状态更新失败', {icon: 2});
                    }
                },
                error: function() {
                    layer.msg('网络错误，请稍后重试', {icon: 2});
                }
            });
        }
        
        // 删除引擎
        window.deleteEngine = function(id) {
            layer.confirm('确定要删除这个AI引擎吗？', {
                title: '删除确认',
                icon: 3
            }, function(index) {
                $.ajax({
                    url: `/api/warehouse/ai_engines/${id}`,
                    type: 'DELETE',
                    success: function(res) {
                        if (res.code === 0) {
                            layer.msg('删除成功', {icon: 1});
                            loadData();
                        } else {
                            layer.msg(res.msg || '删除失败', {icon: 2});
                        }
                    },
                    error: function() {
                        layer.msg('网络错误，请稍后重试', {icon: 2});
                    }
                });
                
                layer.close(index);
            });
        }
        
        // 显示模态框
        function showModal() {
            $('#engine-modal').show();
            $('#modal-mask').show();
        }
        
        // 关闭模态框
        function closeModal() {
            $('#engine-modal').hide();
            $('#modal-mask').hide();
        }
        
        // 暴露closeModal函数到全局，以便模态框中的按钮可以调用
        window.closeModal = closeModal;
    });
</script>
{% endblock %}

{% block css %}
<style>
    /* 引擎卡片样式 */
    .ai-engines-showcase {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .engine-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 20px;
        transition: all 0.3s ease;
        border: 1px solid #e6e6e6;
        position: relative;
        overflow: hidden;
    }
    
    .engine-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transform: translateY(-5px);
        border-color: #1E9FFF;
    }
    
    .engine-card.active {
        border-color: #5FB878;
    }
    
    .engine-card.inactive {
        border-color: #FFB800;
    }
    
    .engine-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .engine-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin: 0;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-badge.active {
        background-color: #5FB878;
        color: #fff;
    }
    
    .status-badge.inactive {
        background-color: #FFB800;
        color: #fff;
    }
    
    .engine-body {
        margin-bottom: 20px;
    }
    
    .engine-model,
    .engine-url,
    .engine-description {
        margin-bottom: 12px;
        display: flex;
        align-items: flex-start;
    }
    
    .engine-model i,
    .engine-url i,
    .engine-description i {
        font-size: 16px;
        margin-right: 10px;
        color: #1E9FFF;
        flex-shrink: 0;
        margin-top: 2px;
    }
    
    .engine-model span,
    .engine-url span {
        color: #666;
        word-break: break-all;
    }
    
    .engine-url span {
        font-size: 13px;
        color: #999;
    }
    
    .engine-description p {
        margin: 0;
        color: #666;
        line-height: 1.5;
        word-break: break-word;
    }
    
    .engine-meta {
        font-size: 12px;
        color: #999;
        border-top: 1px solid #f0f0f0;
        padding-top: 10px;
        margin-top: 15px;
    }
    
    .engine-meta span {
        display: block;
        margin-bottom: 5px;
    }
    
    .engine-footer {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .engine-footer button {
        flex: 1;
        min-width: 80px;
    }
    
    /* 空状态样式 */
    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 80px 20px;
        color: #999;
        font-size: 16px;
        background: #fafafa;
        border-radius: 12px;
        border: 1px dashed #e6e6e6;
    }
    
    /* 模态框样式 */
    .layui-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }
    
    .layui-modal-header {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .layui-modal-header h3 {
        margin: 0;
        font-size: 18px;
        color: #333;
    }
    
    .layui-modal-body {
        padding: 20px;
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
        .ai-engines-showcase {
            grid-template-columns: 1fr;
        }
        
        .engine-footer {
            flex-direction: column;
        }
        
        .engine-footer button {
            width: 100%;
        }
    }
    
    /* 动画效果 */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .engine-card {
        animation: fadeInUp 0.5s ease;
    }
</style>
{% endblock %}