{% extends "base.html" %}
{% block title %}数据仓库管理{% endblock %}

{% block content %}
<style>
    .data-card {
        border: 1px solid #e6e6e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #fff;
        transition: all 0.3s;
    }
    
    .data-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #1E9FFF;
    }
    
    .data-card .cover {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 15px;
        float: left;
    }
    
    .data-card .content {
        margin-left: 120px;
    }
    
    .data-card .title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
    }
    
    .data-card .summary {
        color: #666;
        line-height: 1.5;
        margin-bottom: 10px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    
    .data-card .meta {
        color: #999;
        font-size: 12px;
        margin-bottom: 10px;
    }
    
    .data-card .meta span {
        margin-right: 15px;
    }
    
    .data-card .actions {
        margin-top: 10px;
    }
    
    .data-card .actions button {
        margin-right: 8px;
    }
    
    .filter-container {
        margin-bottom: 20px;
    }
    
    .status-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-right: 5px;
    }
    
    .status-badge.depth-crawled {
        background-color: #5FB878;
        color: #fff;
    }
    
    .status-badge.not-depth-crawled {
        background-color: #FFB800;
        color: #fff;
    }
    
    .status-badge.stored {
        background-color: #1E9FFF;
        color: #fff;
    }
    
    /* 预览模态框样式 */
    .preview-content {
        line-height: 1.6;
    }
    
    .preview-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .preview-meta {
        font-size: 12px;
        color: #666;
        margin-bottom: 20px;
    }
    
    .preview-main-content {
        margin-bottom: 20px;
    }
    
    .preview-main-content img {
        max-width: 100%;
        height: auto;
        margin: 10px 0;
    }
    
    .preview-images,
    .preview-videos,
    .preview-links,
    .preview-meta-data {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .preview-images h4,
    .preview-videos h4,
    .preview-links h4,
    .preview-meta-data h4 {
        margin-bottom: 10px;
        color: #333;
    }
    
    .preview-images img {
        max-width: 200px;
        margin: 5px;
        border: 1px solid #eee;
        padding: 5px;
    }
    
    .preview-videos iframe {
        max-width: 100%;
        margin: 10px 0;
    }
    
    .preview-links a {
        color: #1E9FFF;
        text-decoration: none;
        display: block;
        margin: 5px 0;
    }
    
    .preview-links a:hover {
        text-decoration: underline;
    }
    
    .preview-meta-data pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
    }
    
    .status-badge.not-stored {
        background-color: #FF5722;
        color: #fff;
    }
    
    .select-all-container {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f8f8;
        border-radius: 4px;
    }
    
    /* 模态框样式 */
    .layui-modal-body {
        max-height: 600px;
        overflow-y: auto;
    }
    
    /* 响应式布局 */
    @media (max-width: 768px) {
        .data-card .cover {
            width: 80px;
            height: 80px;
        }
        
        .data-card .content {
            margin-left: 95px;
        }
    }
</style>

<!-- 内容区域 -->
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">
                    <h2>数据仓库管理</h2>
                    <p>管理和分析采集到的数据</p>
                </div>
                <div class="layui-card-body">
                    <!-- 数据搜索筛选 -->
                    <div class="filter-container">
                        <form class="layui-form layui-form-pane" id="filter-form">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label">搜索关键词</label>
                                    <div class="layui-input-inline" style="width: 200px;">
                                        <input type="text" name="keyword" id="keyword" placeholder="请输入关键词" autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">数据源</label>
                                    <div class="layui-input-inline" style="width: 120px;">
                                        <select name="source" id="source">
                                            <option value="">全部数据源</option>
                                            <option value="baidu">百度搜索</option>
                                            <option value="bing">Bing搜索</option>
                                            <option value="xinhua">新华新闻</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <button class="layui-btn" id="search-btn" lay-submit lay-filter="search">搜索</button>
                                    <button type="reset" class="layui-btn layui-btn-primary" id="reset-btn">重置</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!-- 批量操作 -->
                    <div class="select-all-container">
                        <div class="layui-form">
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <input type="checkbox" name="select_all" id="select_all" lay-skin="primary" title="全选">
                                    <button class="layui-btn layui-btn-sm layui-btn-danger" id="batch-delete-btn">批量删除</button>
                                    <button class="layui-btn layui-btn-sm layui-btn-warm" id="ai-analyze-btn">AI分析</button>
                                    <button class="layui-btn layui-btn-sm layui-btn-success" id="batch-detailed-crawl-btn">批量详细采集</button>
                                    <span id="selected-count" style="margin-left: 10px; color: #666;">已选择 0 项</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 数据列表 -->
                    <div id="data-list" class="data-list">
                        <!-- 数据将通过JavaScript动态加载 -->
                    </div>
                    
                    <!-- 分页 -->
                    <div id="pagination" class="pagination">
                        <!-- 分页将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>

    <!-- 编辑数据模态框 -->
    <div id="edit-modal" class="layui-modal" style="display: none;">
        <div class="layui-modal-content">
            <div class="layui-modal-header">
                <h3>编辑数据</h3>
                <a href="javascript:;" class="layui-modal-close" id="close-edit-modal">&times;</a>
            </div>
            <div class="layui-modal-body">
                <form class="layui-form" id="edit-form">
                    <input type="hidden" name="id" id="edit-id">
                    <div class="layui-form-item">
                        <label class="layui-form-label">采集关键词</label>
                        <div class="layui-input-block">
                            <input type="text" name="keyword" id="edit-keyword" class="layui-input" readonly>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">标题</label>
                        <div class="layui-input-block">
                            <input type="text" name="title" id="edit-title" required lay-verify="required" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">摘要</label>
                        <div class="layui-input-block">
                            <textarea name="summary" id="edit-summary" rows="3" class="layui-textarea"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">封面图片</label>
                        <div class="layui-input-block">
                            <input type="text" name="cover" id="edit-cover" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">原始URL</label>
                        <div class="layui-input-block">
                            <input type="text" name="original_url" id="edit-original_url" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">数据源</label>
                        <div class="layui-input-block">
                            <select name="source" id="edit-source">
                                <option value="baidu">百度搜索</option>
                                <option value="bing">Bing搜索</option>
                                <option value="xinhua">新华新闻</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn" id="save-edit-btn" lay-submit lay-filter="save-edit">保存修改</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- AI分析结果模态框 -->
    <div id="ai-result-modal" class="layui-modal" style="display: none;">
        <div class="layui-modal-content">
            <div class="layui-modal-header">
                <h3>AI分析结果</h3>
                <a href="javascript:;" class="layui-modal-close" id="close-ai-modal">&times;</a>
            </div>
            <div class="layui-modal-body">
                <div id="ai-result-content">
                    <!-- AI分析结果将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 引入layui脚本 -->
    <script src="{{ url_for('static', filename='layui/layui.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        // 初始化layui组件
        layui.use(['form', 'laydate', 'element', 'layer', 'laypage'], function() {
            var form = layui.form,
                layer = layui.layer,
                element = layui.element,
                laypage = layui.laypage;
            
            // 全局变量
            var currentPage = 1;
            var pageSize = 10;
            var selectedIds = [];
            
            // 页面加载时获取数据
            loadData();
            
            // 加载数据
            function loadData() {
                var keyword = $('#keyword').val();
                var source = $('#source').val();
                
                $.get("{{ url_for('warehouse.get_warehouse_data') }}", {
                    page: currentPage,
                    limit: pageSize,
                    keyword: keyword,
                    source: source
                }, function(res) {
                    if (res.success) {
                        renderData(res.data);
                        renderPagination(res.total, currentPage, pageSize);
                    } else {
                        layer.msg(res.message, {icon: 2});
                        $('#data-list').html('<div class="layui-text-center" style="padding: 50px 0;"><p>加载数据失败</p></div>');
                    }
                }, 'json').fail(function() {
                    layer.msg('加载数据失败，请重试', {icon: 2});
                    $('#data-list').html('<div class="layui-text-center" style="padding: 50px 0;"><p>加载数据失败</p></div>');
                });
            }
            
            // 渲染数据列表
            function renderData(data) {
                var html = '';
                
                if (data.length === 0) {
                    html = '<div class="layui-text-center" style="padding: 50px 0;"><p>暂无数据</p></div>';
                } else {
                    data.forEach(function(item) {
                        // 生成状态标签
                        var depthStatus = item.depth_crawled ? 
                            '<span class="status-badge depth-crawled">已深度采集</span>' : 
                            '<span class="status-badge not-depth-crawled">未深度采集</span>';
                            
                        var storeStatus = item.is_stored ? 
                            '<span class="status-badge stored">已存储</span>' : 
                            '<span class="status-badge not-stored">未存储</span>';
                        
                        html += `
                            <div class="data-card">
                                <div class="layui-form">
                                    <div class="layui-form-item">
                                        <div class="layui-input-block">
                                            <input type="checkbox" name="data_ids" lay-skin="primary" title="" value="${item.id}">
                                        </div>
                                    </div>
                                </div>
                                <div class="cover-container">
                                    ${item.cover ? `<img src="${item.cover}" alt="封面" class="cover">` : ''}
                                </div>
                                <div class="content">
                                    <h3 class="title">${item.title}</h3>
                                    <p class="summary">${item.summary || '暂无摘要'}</p>
                                    <div class="meta">
                                        <span>关键词：${item.keyword}</span>
                                        <span> | </span>
                                        <span>来源：${item.source || '未知'}</span>
                                        <span> | </span>
                                        <span>采集时间：${item.created_at}</span>
                                    </div>
                                    <div class="meta">
                                        ${storeStatus}
                                    </div>
                                    <div class="actions">
                                        <a href="${item.original_url}" target="_blank" class="layui-btn layui-btn-xs layui-btn-primary">查看原文</a>
                                        <button class="layui-btn layui-btn-xs layui-btn-success data-detail-crawl" data-id="${item.id}">详细采集</button>
                                        <button class="layui-btn layui-btn-xs layui-btn-primary data-preview" data-id="${item.id}">预览</button>
                                        <button class="layui-btn layui-btn-xs layui-btn-normal data-edit" data-id="${item.id}">编辑</button>
                                        <button class="layui-btn layui-btn-xs layui-btn-danger data-delete" data-id="${item.id}">删除</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                $('#data-list').html(html);
                form.render(); // 重新渲染表单元素
                
                // 绑定复选框事件
                bindCheckboxEvents();
            }
            
            // 渲染分页
            function renderPagination(total, current, limit) {
                laypage.render({
                    elem: 'pagination',
                    count: total,
                    curr: current,
                    limit: limit,
                    layout: ['prev', 'page', 'next', 'count', 'skip'],
                    jump: function(obj, first) {
                        if (!first) {
                            currentPage = obj.curr;
                            pageSize = obj.limit;
                            loadData();
                        }
                    }
                });
            }
            
            // 绑定复选框事件
            function bindCheckboxEvents() {
                // 单个复选框事件
                $('input[name="data_ids"]').on('change', function() {
                    updateSelectedIds();
                });
                
                // 全选复选框事件
                $('#select_all').on('change', function() {
                    var isChecked = $(this).prop('checked');
                    $('input[name="data_ids"]').prop('checked', isChecked);
                    form.render();
                    updateSelectedIds();
                });
            }
            
            // 更新选中的ID列表
            function updateSelectedIds() {
                selectedIds = [];
                $('input[name="data_ids"]:checked').each(function() {
                    selectedIds.push($(this).val());
                });
                $('#selected-count').text('已选择 ' + selectedIds.length + ' 项');
                
                // 更新全选状态
                var allChecked = $('input[name="data_ids"]').length === selectedIds.length;
                $('#select_all').prop('checked', allChecked);
                form.render();
            }
            
            // 搜索事件
            form.on('submit(search)', function(data) {
                currentPage = 1;
                loadData();
                return false;
            });
            
            // 重置事件
            $('#reset-btn').on('click', function() {
                $('#keyword').val('');
                $('#source').val('');
                form.render();
                currentPage = 1;
                loadData();
            });
            
            // 批量删除
            $('#batch-delete-btn').on('click', function() {
                if (selectedIds.length === 0) {
                    layer.msg('请选择要删除的数据', {icon: 2});
                    return;
                }
                
                layer.confirm('确定要删除选中的 ' + selectedIds.length + ' 条数据吗？', {
                    btn: ['确定', '取消'],
                    icon: 3
                }, function(index) {
                    layer.close(index);
                    
                    $.post("{{ url_for('warehouse.batch_delete_warehouse_data') }}", {
                        result_ids: JSON.stringify(selectedIds)
                    }, function(res) {
                        if (res.success) {
                            layer.msg(res.message, {icon: 1});
                            loadData();
                            selectedIds = [];
                        } else {
                            layer.msg(res.message, {icon: 2});
                        }
                    }, 'json').fail(function() {
                        layer.msg('删除失败，请重试', {icon: 2});
                    });
                });
            });
            
            // AI分析
            $('#ai-analyze-btn').on('click', function() {
                if (selectedIds.length === 0) {
                    layer.msg('请选择要分析的数据', {icon: 2});
                    return;
                }
                
                layer.confirm('确定要对选中的 ' + selectedIds.length + ' 条数据进行AI分析吗？', {
                    btn: ['确定', '取消'],
                    icon: 3
                }, function(index) {
                    layer.close(index);
                    
                    // 显示加载中
                    var loadingIndex = layer.load(2, {shade: [0.5, '#393D49']});
                    
                    $.post("{{ url_for('warehouse.ai_analyze_data') }}", {
                        data_ids: JSON.stringify(selectedIds),
                        analyze_type: 'general'
                    }, function(res) {
                        layer.close(loadingIndex);
                        
                        if (res.success) {
                            // 显示AI分析结果
                            showAiResult(res);
                        } else {
                            layer.msg(res.message, {icon: 2});
                        }
                    }, 'json').fail(function() {
                        layer.close(loadingIndex);
                        layer.msg('分析失败，请重试', {icon: 2});
                    });
                });
            });
            
            // 详细内容采集（单个数据）
            $(document).on('click', '.data-detail-crawl', function() {
                var id = $(this).data('id');
                layer.confirm('确定要对这条数据进行详细内容采集吗？', {
                    btn: ['确定', '取消'],
                    icon: 3
                }, function(index) {
                    layer.close(index);
                    
                    // 显示加载中
                    var loadingIndex = layer.load(2, {shade: [0.5, '#393D49']});
                    
                    $.post("{{ url_for('warehouse.detailed_crawl_data', data_id=0) }}".replace('0', id), function(res) {
                        layer.close(loadingIndex);
                        
                        if (res.success) {
                            layer.msg(res.message, {icon: 1});
                            loadData();
                        } else {
                            layer.msg(res.message, {icon: 2});
                        }
                    }, 'json').fail(function() {
                        layer.close(loadingIndex);
                        layer.msg('详细内容采集失败，请重试', {icon: 2});
                    });
                });
            });
            
            // 批量详细内容采集
            $('#batch-detailed-crawl-btn').on('click', function() {
                if (selectedIds.length === 0) {
                    layer.msg('请选择要进行详细采集的数据', {icon: 2});
                    return;
                }
                
                layer.confirm('确定要对选中的 ' + selectedIds.length + ' 条数据进行详细内容采集吗？', {
                    btn: ['确定', '取消'],
                    icon: 3
                }, function(index) {
                    layer.close(index);
                    
                    // 显示加载中
                    var loadingIndex = layer.load(2, {shade: [0.5, '#393D49']});
                    
                    $.post("{{ url_for('warehouse.batch_detailed_crawl_data') }}", {
                        data_ids: JSON.stringify(selectedIds)
                    }, function(res) {
                        layer.close(loadingIndex);
                        
                        if (res.success) {
                            layer.msg(res.message, {icon: 1});
                            // 显示采集结果统计
                            layer.msg('采集完成：成功 ' + res.data.success_count + ' 条，失败 ' + res.data.fail_count + ' 条', {icon: 1});
                            loadData();
                            selectedIds = [];
                        } else {
                            layer.msg(res.message, {icon: 2});
                        }
                    }, 'json').fail(function() {
                        layer.close(loadingIndex);
                        layer.msg('批量详细内容采集失败，请重试', {icon: 2});
                    });
                });
            });
            
            // 保存编辑数据
            form.on('submit(save-edit)', function(data) {
                var id = $('#edit-id').val();
                
                $.ajax({
                    url: "{{ url_for('warehouse.update_warehouse_data', data_id=0) }}".replace('0', id),
                    type: 'PUT',
                    data: data.field,
                    success: function(res) {
                        if (res.success) {
                            layer.msg(res.message, {icon: 1});
                            $('#edit-modal').hide();
                            loadData();
                        } else {
                            layer.msg(res.message, {icon: 2});
                        }
                    },
                    error: function() {
                        layer.msg('更新失败，请重试', {icon: 2});
                    }
                });
                
                return false;
            });
            
            // 关闭编辑模态框
            $('#close-edit-modal').on('click', function() {
                $('#edit-modal').hide();
            });
            
            // 关闭AI分析结果模态框
            $('#close-ai-modal').on('click', function() {
            $('#ai-result-modal').hide();
        });
        

            
            // 点击模态框外部关闭
            $(document).on('click', function(e) {
            if ($(e.target).hasClass('layui-modal')) {
                $(e.target).hide();
            }
        });
        
        // 预览详细内容函数
        $(document).on('click', '.data-preview', function() {
            var dataId = $(this).data('id');
            // 显示加载状态
            layui.layer.load(2, {shade: [0.5, '#393D49']});
            
            // 发送请求获取详细数据
            $.ajax({
                url: `/api/warehouse/data/${dataId}`,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                        // 关闭加载状态
                        layui.layer.closeAll('loading');
                        
                        if (response.success) {
                            const data = response.data;
                            const depthData = data.depth_data;
                            
                            // 生成预览内容
                            let previewHtml = `
                                <div class="preview-content" style="max-height: 90vh; overflow-y: auto; padding: 20px;">
                                    <h3 class="preview-title" style="margin-top: 0; margin-bottom: 15px; font-size: 18px; font-weight: bold;">${data.title}</h3>
                                    <div class="preview-meta" style="margin-bottom: 20px; color: #666; font-size: 14px;">
                                        <span>来源：${data.source}</span> | 
                                        <span>创建时间：${data.created_at}</span> | 
                                        <span>最后更新：${data.updated_at}</span>
                                    </div>
                                    
                                    <div class="preview-main-content" style="margin-bottom: 20px;">
                            `;
                            
                            if (depthData && depthData.content) {
                                previewHtml += depthData.content;
                            } else {
                                previewHtml += '<div style="color: #999; text-align: center; padding: 50px;">暂无详细内容</div>';
                            }
                            
                            previewHtml += '</div>';
                            
                            // 添加图片
                            if (depthData && depthData.images && depthData.images.length > 0) {
                                previewHtml += '<h4 style="margin: 20px 0 10px;">图片</h4>';
                                depthData.images.forEach(img => {
                                    previewHtml += `<img src="${img}" alt="内容图片" title="点击查看大图" class="preview-image" data-src="${img}" style="max-width: 100%; margin: 10px 0; cursor: pointer;">`;
                                });
                            }
                            
                            // 添加视频
                            if (depthData && depthData.videos && depthData.videos.length > 0) {
                                previewHtml += '<h4 style="margin: 20px 0 10px;">视频</h4>';
                                depthData.videos.forEach(video => {
                                    previewHtml += `<div style="margin: 10px 0;"><iframe src="${video}" width="100%" height="300" frameborder="0" allowfullscreen></iframe></div>`;
                                });
                            }
                            
                            // 添加链接
                            if (depthData && depthData.links && depthData.links.length > 0) {
                                previewHtml += '<h4 style="margin: 20px 0 10px;">相关链接</h4>';
                                depthData.links.forEach(link => {
                                    previewHtml += `<a href="${link}" target="_blank" style="display: block; margin: 5px 0; color: #1E9FFF;">${link}</a>`;
                                });
                            }
                            
                            // 添加元数据
                            if (depthData && depthData.meta_data && Object.keys(depthData.meta_data).length > 0) {
                                previewHtml += '<h4 style="margin: 20px 0 10px;">元数据</h4>';
                                previewHtml += '<pre style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">' + JSON.stringify(depthData.meta_data, null, 2) + '</pre>';
                            }
                            
                            previewHtml += '</div>';
                            
                            // 创建layer弹出窗口
                            layui.layer.open({
                                type: 1,
                                title: '详细内容预览',
                                area: ['90%', '90vh'],
                                maxWidth: 1200,
                                content: previewHtml,
                                shadeClose: true,
                                success: function(layero) {
                                    // 为弹出窗口中的图片绑定点击事件
                                    layero.find('.preview-image').on('click', function() {
                                        var imgUrl = $(this).data('src');
                                        layui.layer.open({
                                            type: 1,
                                            title: '图片预览',
                                            area: ['auto', 'auto'],
                                            content: `<img src="${imgUrl}" style="max-width: 90vw; max-height: 90vh;">`
                                        });
                                    });
                                }
                            });
                        } else {
                            layui.layer.msg(response.message || '获取数据失败', {icon: 2});
                        }
                },
                error: function(xhr, status, error) {
                        layui.layer.closeAll('loading');
                        layui.layer.msg('获取数据失败: ' + error, {icon: 2});
                    }
            });
        });
        
        // 图片预览函数
        $(document).on('click', '.preview-image', function() {
            var imgUrl = $(this).data('src');
            layui.layer.open({
                type: 1,
                title: '图片预览',
                area: ['auto', 'auto'],
                content: `<img src="${imgUrl}" style="max-width: 90vw; max-height: 90vh;">`
            });
        });
        });
        
        // 编辑数据
        $(document).on('click', '.data-edit', function() {
            var id = $(this).data('id');
            $.get("{{ url_for('warehouse.get_warehouse_data_detail', data_id=0) }}".replace('0', id), function(res) {
                if (res.success) {
                    var data = res.data;
                    $('#edit-id').val(data.id);
                    $('#edit-keyword').val(data.keyword);
                    $('#edit-title').val(data.title);
                    $('#edit-summary').val(data.summary);
                    $('#edit-cover').val(data.cover);
                    $('#edit-original_url').val(data.original_url);
                    $('#edit-source').val(data.source);
                    
                    layui.form.render();
                    $('#edit-modal').show();
                } else {
                    layui.layer.msg(res.message, {icon: 2});
                }
            }, 'json').fail(function() {
                layui.layer.msg('获取数据详情失败，请重试', {icon: 2});
            });
        });
        
        // 删除数据
        $(document).on('click', '.data-delete', function() {
            var id = $(this).data('id');
            layui.layer.confirm('确定要删除这条数据吗？', {
                btn: ['确定', '取消'],
                icon: 3
            }, function(index) {
                layui.layer.close(index);
                
                $.ajax({
                    url: "{{ url_for('warehouse.delete_warehouse_data', data_id=0) }}".replace('0', id),
                    type: 'DELETE',
                    success: function(res) {
                        if (res.success) {
                            layui.layer.msg(res.message, {icon: 1});
                            loadData();
                        } else {
                            layui.layer.msg(res.message, {icon: 2});
                        }
                    },
                    error: function() {
                        layui.layer.msg('删除失败，请重试', {icon: 2});
                    }
                });
            });
        });


        
        // 显示AI分析结果
        function showAiResult(res) {
            var result = res.analysis_result;
            var html = `
                <div class="layui-card">
                    <div class="layui-card-header">
                        <h3 class="layui-card-title">AI分析结果</h3>
                    </div>
                    <div class="layui-card-body">
                        <div class="layui-form">
                            <div class="layui-form-item">
                                <label class="layui-form-label">分析类型</label>
                                <div class="layui-input-block">
                                    <span class="layui-form-mid layui-word-aux">${res.analyze_type}</span>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">分析数据量</label>
                                <div class="layui-input-block">
                                    <span class="layui-form-mid layui-word-aux">${res.data_count} 条</span>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">情感倾向</label>
                                <div class="layui-input-block">
                                    <span class="layui-form-mid layui-word-aux">${result.sentiment}</span>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">关键词</label>
                                <div class="layui-input-block">
                                    ${result.keywords.map(word => `<span class="layui-badge">${word}</span>`).join(' ')}
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">主题分类</label>
                                <div class="layui-input-block">
                                    ${result.topics.map(topic => `<span class="layui-badge layui-bg-blue">${topic}</span>`).join(' ')}
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label">分析总结</label>
                                <div class="layui-input-block">
                                    <p>${result.summary}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#ai-result-content').html(html);
            $('#ai-result-modal').show();
        }
    </script>
    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}